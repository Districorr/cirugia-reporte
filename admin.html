<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reportes guardados | Districorr</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E",
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };
    
    // Inicialización mejorada con manejo de errores
    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      window.onload = () => {
        const tbody = document.getElementById("reporte-rows");
        // Añadido spinner de carga
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Cargando reportes...</td></tr>';
        
        db.collection("reportes").orderBy("timestamp", "desc").get()
          .then(snapshot => {
            tbody.innerHTML = '';
            if (snapshot.empty) {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay reportes guardados</td></tr>';
              return;
            }
            
            snapshot.forEach(doc => {
              const data = doc.data();
              const tr = document.createElement("tr");
              // Formateo de fecha mejorado con manejo de errores
              let fechaFormateada = 'Fecha no disponible';
              try {
                if (data.fechaCirugia) {
                  fechaFormateada = new Date(data.fechaCirugia).toLocaleDateString("es-AR");
                } else if (data.timestamp) {
                  fechaFormateada = new Date(data.timestamp).toLocaleDateString("es-AR");
                }
              } catch (e) {
                console.error("Error formateando fecha:", e);
              }
              
              tr.innerHTML = `
                <td>${data.paciente || 'No especificado'}</td>
                <td>${data.medico || 'No especificado'}</td>
                <td>${data.tipoCirugia || 'No especificado'}</td>
                <td>${fechaFormateada}</td>
                <td>${data.material ? data.material.substring(0, 30) + (data.material.length > 30 ? '...' : '') : 'No especificado'}</td>`;
              tbody.appendChild(tr);
            });
          })
          .catch(error => {
            console.error("Error cargando reportes:", error);
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">Error cargando reportes</td></tr>';
          });
      };
    } catch (e) {
      console.error("Error inicializando Firebase:", e);
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById("reporte-rows").innerHTML = 
          '<tr><td colspan="5" style="text-align:center;color:red;">Error de conexión con la base de datos</td></tr>';
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <h2>Panel de Reportes Enviados</h2>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Paciente</th>
            <th>Médico</th>
            <th>Tipo</th>
            <th>Fecha</th>
            <th>Material</th>
          </tr>
        </thead>
        <tbody id="reporte-rows"></tbody>
      </table>
    </div>
    <a href="index.html" class="btn-volver">← Volver al formulario</a>
  </div>
</body>
</html>
