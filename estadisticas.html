<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estadísticas de Cirugías | Districorr</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="spinner" id="spinner"></div>
  <div class="container">
    <header>
      <img src="https://i.imgur.com/aA7RzTN.png" alt="Districorr Logo" class="logo-header">
      <h2>📊 Estadísticas Mensuales de Cirugías</h2>
    </header>
    
    <div id="loading" style="text-align: center; margin: 20px;">Cargando estadísticas...</div>
    
    <div id="chartsContainer" style="display: none;">
      <div style="margin: 30px 0;">
        <canvas id="chartCirugias"></canvas>
      </div>
      
      <div style="margin: 30px 0;">
        <canvas id="chartTipos"></canvas>
      </div>
      
      <div style="margin: 30px 0;">
        <canvas id="chartMedicos"></canvas>
      </div>
      
      <div class="export-buttons" style="text-align: center; margin-top: 20px;">
        <button onclick="exportarExcel()" class="btn-link">📥 Exportar a Excel</button>
        <button onclick="window.print()" class="btn-link">🖨️ Imprimir / Guardar como PDF</button>
      </div>
    </div>
    
    <div class="text-center" style="margin-top: 20px;">
      <a href="index.html" class="btn-link">← Volver al formulario</a>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCFtuuSPCcQIkgDN_F1WRS4U-71pRNCf_E",
      authDomain: "cirugia-reporte.firebaseapp.com",
      projectId: "cirugia-reporte",
      storageBucket: "cirugia-reporte.appspot.com",
      messagingSenderId: "698831567840",
      appId: "1:698831567840:web:fc6d6197f22beba4d88985",
      measurementId: "G-HD7ZLL1GLZ"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let datosExportar = [];

    // Función para agrupar por mes
    function agruparPorMes(data) {
      const meses = {};
      data.forEach(item => {
        if (item.timestamp) {
          const fecha = item.timestamp.toDate();
          const mes = fecha.getMonth() + 1;
          const año = fecha.getFullYear();
          const clave = `${mes}/${año}`;
          
          meses[clave] = (meses[clave] || 0) + 1;
        }
      });
      return meses;
    }

    // Función para agrupar por tipo de cirugía
    function agruparPorTipo(data) {
      const tipos = {};
      data.forEach(item => {
        const tipo = item.tipoCirugia || 'No especificado';
        tipos[tipo] = (tipos[tipo] || 0) + 1;
      });
      
      // Ordenar por cantidad descendente
      return Object.entries(tipos)
        .sort((a, b) => b[1] - a[1])
        .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});
    }

    // Función para agrupar por médico
    function agruparPorMedico(data) {
      const medicos = {};
      data.forEach(item => {
        const medico = item.medico || 'No especificado';
        medicos[medico] = (medicos[medico] || 0) + 1;
      });
      
      // Ordenar por cantidad descendente y tomar los top 10
      return Object.entries(medicos)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});
    }

    // Función para crear gráfico de cirugías por mes
    function crearGraficoCirugiasPorMes(data) {
      const mesesData = agruparPorMes(data);
      const ctx = document.getElementById('chartCirugias').getContext('2d');
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(mesesData),
          datasets: [{
            label: 'Cirugías por Mes',
            data: Object.values(mesesData),
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Cirugías por Mes',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Cantidad de Cirugías' }
            }
          }
        }
      });
    }

    // Función para crear gráfico de tipos de cirugía
    function crearGraficoTiposCirugia(data) {
      const tiposData = agruparPorTipo(data);
      const ctx = document.getElementById('chartTipos').getContext('2d');
      
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(tiposData),
          datasets: [{
            data: Object.values(tiposData),
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Tipos de Cirugía Más Comunes',
              font: { size: 16 }
            },
            legend: { position: 'right' }
          }
        }
      });
    }

    // Función para crear gráfico de médicos
    function crearGraficoMedicos(data) {
      const medicosData = agruparPorMedico(data);
      const ctx = document.getElementById('chartMedicos').getContext('2d');
      
      new Chart(ctx, {
        type: 'horizontalBar',
        data: {
          labels: Object.keys(medicosData),
          datasets: [{
            label: 'Cirugías',
            data: Object.values(medicosData),
            backgroundColor: 'rgba(75, 192, 192, 0.7)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Top 10 Médicos con Más Cirugías',
              font: { size: 16 }
            },
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    // Función para exportar a Excel
    function exportarExcel() {
      if (datosExportar.length === 0) {
        alert('No hay datos para exportar');
        return;
      }

      const datosFormateados = datosExportar.map(item => ({
        'Paciente': item.paciente || '',
        'Médico': item.medico || '',
        'Tipo de Cirugía': item.tipoCirugia || '',
        'Fecha de Cirugía': item.fechaCirugia ? new Date(item.fechaCirugia).toLocaleDateString('es-AR') : '',
        'Material': item.material || '',
        'Fecha de Registro': item.timestamp ? item.timestamp.toDate().toLocaleString('es-AR') : ''
      }));

      const ws = XLSX.utils.json_to_sheet(datosFormateados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Reportes");
      
      const fecha = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `Reportes_Cirugias_${fecha}.xlsx`);
    }

    // Cargar datos y crear gráficos
    window.onload = function() {
      document.getElementById('spinner').style.display = 'block';
      
      db.collection("reportes").orderBy("timestamp", "desc").get()
        .then(snapshot => {
          datosExportar = snapshot.docs.map(doc => {
            const data = doc.data();
            return { ...data, id: doc.id, timestamp: data.timestamp };
          });
          
          // Crear gráficos
          crearGraficoCirugiasPorMes(datosExportar);
          crearGraficoTiposCirugia(datosExportar);
          crearGraficoMedicos(datosExportar);
          
          // Ocultar spinner y mostrar gráficos
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('loading').style.display = 'none';
          document.getElementById('chartsContainer').style.display = 'block';
        })
        .catch(error => {
          console.error("Error al cargar datos:", error);
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('loading').textContent = 'Error al cargar los datos. Intente nuevamente.';
        });
    };
  </script>
</body>
</html>
